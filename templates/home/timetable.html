{% load category_tags %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì‹œê°„í‘œ ìƒì„±</title>

    {% load static %}

    <link rel="stylesheet" type="text/css" href="{% static 'home/css/base_style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'home/css/timetable_style.css' %}">

    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS ì¶”ê°€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- (ì¶”ê°€) ì§„í–‰ ìƒí™© ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ -->
    <style>
      #progress-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          z-index: 10000;
      }
      #progress-message {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
      }
      #progress-bar {
          width: 300px;
          height: 20px;
          background: #ddd;
          border-radius: 10px;
          overflow: hidden;
          margin-top: 10px;
      }
      #progress-fill {
          width: 0%;
          height: 100%;
          background: #4caf50;
      }
      
      /* ì±—ë´‡ ì €ì¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (From Uiverse.io by vinodjangid07) */
      .bookmarkBtn {
        width: 130px;
        height: 40px;
        border-radius: 40px;
        border: 1px solid rgba(0, 0, 0, 0.349);
        background-color: rgb(255, 255, 255);
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding-left: 5px;
        cursor: pointer;
        transition-duration: 0.3s;
        overflow: hidden;
        margin-right: 5px;
        position: relative;
      }

      .IconContainer {
        width: 30px;
        height: 30px;
        background: linear-gradient(to bottom, rgb(255, 239, 136), rgb(255, 215, 70));
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        z-index: 3;
        transition-duration: 0.3s;
      }

      .icon {
        border-radius: 1px;
        fill: white;
      }

      .text {
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: 7px;
        transform: translate(-50%, -50%);
        color: rgb(0, 0, 0);
        z-index: 1;
        transition-duration: 0.3s;
        font-size: 1.04em;
        white-space: nowrap;
      }

      .bookmarkBtn:hover .IconContainer {
        width: 120px;
        height: 36px;
        border-radius: 40px;
        transition-duration: 0.3s;
      }

      .bookmarkBtn:hover .text {
        transform: translate(-50%, -50%);
        opacity: 0;
        transition-duration: 0.3s;
      }

      .bookmarkBtn:active {
        transform: scale(0.95);
        transition-duration: 0.3s;
      }
      

      
      /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ì •ë ¬ */
      .chat-buttons {
        display: flex;
        align-items: center;
        justify-content: flex-start;
      }
    </style>
    
</head>
<body>
    <!-- header -->
    <header>
        <nav class="navigation">
            <a href="{% url 'dashboard' %}" class="logo">
                <img src="https://github.com/KSM017/ImageSource/blob/main/002.png?raw=true" alt="ë¡œê³ ">
            </a>
            <div class="nav-links">
                <a href="{% url 'dashboard' %}">Home<span></span></a>
                <a href="{% url 'manage' %}">Manage<span></span></a>
                <a href="{% url 'mypage' %}">MyPage<span></span></a>
                <a href="{% url 'timetable' %}">TimeTable<span></span></a>
                <a href="#">Logout<span></span></a>
            </div>
        </nav>
    </header> 
    <!-- ì»¨í…Œì´ë„ˆ -->
    <div class="container-fluid">
        <!-- ì™¼ìª½ íŒ¨ë„: ê°•ì˜ ê²€ìƒ‰/í•„í„° ë° ê°•ì˜ ëª©ë¡ -->
        <div class="left-panel p-3 border-end overflow-auto">
            {% category_dropdown %}           {# â† ë“œë¡­ë‹¤ìš´ + ê²€ìƒ‰ë²„íŠ¼ + ê²°ê³¼í…Œì´ë¸” ì¼ê´„ í¬í•¨ #}
        </div>
        <!-- ê°€ìš´ë° íŒ¨ë„: ì‹œê°„í‘œ í‘œì‹œ -->
        <div class="middle-panel">
            <table class="timetable">
                <thead>
                    <tr>
                        <th>ì‹œê°„</th>
                        <th>ì›”</th>
                        <th>í™”</th>
                        <th>ìˆ˜</th>
                        <th>ëª©</th>
                        <th>ê¸ˆ</th>
                    </tr>
                </thead>
                <tbody>
                    <script>
                        const timetableBody = document.querySelector(".timetable tbody");
                        for (let hour = 9; hour <= 18; hour++) {
                            const row = document.createElement("tr");
                            const timeCell = document.createElement("td");
                            timeCell.textContent = `${hour}:00`;
                            row.appendChild(timeCell);
                            for (let i = 0; i < 5; i++) {
                                const cell = document.createElement("td");
                                cell.classList.add("timetable-cell");
                                cell.setAttribute("data-hour", hour);
                                cell.setAttribute("data-day", i);
                                row.appendChild(cell);
                            }
                            timetableBody.appendChild(row);
                        }
                    </script>
                </tbody>
            </table>
        </div>
        <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: ì„¤ì • ë° íƒìƒ‰ -->
        <div class="right-panel">
            <div class="goal-settings">
                <h3>ëª©í‘œ í•™ì  ì„¤ì • ğŸ¯</h3>
                <div class="goal-inputs">
                    <label for="total-credits">ì´ ëª©í‘œ í•™ì  (ìµœëŒ€ 24):</label>
                    <input type="number" id="total-credits" min="1" max="24" value="18">
                    
                    <label for="major-credits">ì „ê³µ í•™ì :</label>
                    <input type="number" id="major-credits" min="0" max="24" value="9">
                    
                    <label for="elective-credits">êµì–‘ í•™ì :</label>
                    <input type="number" id="elective-credits" min="0" max="24" value="9">
                </div>
            </div>
            <div class="day-off-settings">
                <h3>í¬ë§ ê³µê°• ìš”ì¼ ğŸ“…</h3>
                <div class="day-options">
                    <label><input type="checkbox" value="ì›”"> ì›”</label>
                    <label><input type="checkbox" value="í™”"> í™”</label>
                    <label><input type="checkbox" value="ìˆ˜"> ìˆ˜</label>
                    <label><input type="checkbox" value="ëª©"> ëª©</label>
                    <label><input type="checkbox" value="ê¸ˆ"> ê¸ˆ</label>
                </div>
            </div>
            <button id="generate-btn">ğŸ“… ì‹œê°„í‘œ ìƒì„±</button>
            <div class="timetable-navigation">
                <button id="prev-timetable" class="nav-arrow">â—€</button>
                <span id="timetable-index">1 / 1</span>
                <button id="next-timetable" class="nav-arrow">â–¶</button>
            </div>
            <button id="save-timetable-btn">ğŸ’¾ í˜„ì¬ ì‹œê°„í‘œ ì €ì¥</button>

        </div>
    </div>
    
    <!-- ì§„í–‰ ìƒí™© ì˜¤ë²„ë ˆì´ (ì¶”ê°€ëœ ë¶€ë¶„) -->
    <div id="progress-overlay">
      <div id="progress-message">
        <p id="progress-text">ì‹œê°„í‘œ ìƒì„± ì¤‘...</p>
        <div id="progress-bar">
          <div id="progress-fill"></div>
        </div>
        <p id="progress-count"></p>
      </div>
    </div>


    <!-- AI ì±„íŒ…ì°½ -->
    <div id="ai-chat-toggle">ğŸ’¬</div>
    <div id="ai-chat-widget">
        <div class="ai-chat-header">
            <img src="https://github.com/KSM017/ImageSource/blob/main/002.png?raw=true" alt="AI" class="ai-avatar">
            <div class="ai-info">
                <strong>Timey</strong><br>
                <small>AI ë„ìš°ë¯¸</small>
            </div>
            <button id="ai-close-btn">Ã—</button>
        </div>
        <div class="ai-chat-body">
            <div class="chat-time" id="chat-time-initial"></div>
            <div class="chat-bubble bot">ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” Timeyì…ë‹ˆë‹¤.<br>ê¶ê¸ˆí•˜ì‹  ì ì„ ì•Œë ¤ì£¼ì‹œë©´ ë‹µë³€ë“œë¦´ê²Œìš”!</div>
        </div>
        <div class="ai-chat-input">
           <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
           <button>â¤</button>
        </div>
    </div>            

    <script src="{% static 'home/js/timetable_script.js' %}"></script>
    <!-- AI ì±„íŒ…ì°½ ê¸°ëŠ¥ -->
    <script>
        let existingCourses = [];
        const chatToggle = document.getElementById("ai-chat-toggle");
        const chatWidget = document.getElementById("ai-chat-widget");
        const closeBtn = document.getElementById("ai-close-btn");
        const input = document.querySelector(".ai-chat-input input");
        const sendBtn = document.querySelector(".ai-chat-input button");
        const chatBody = document.querySelector(".ai-chat-body");
      
        chatToggle.addEventListener("click", () => {
          chatWidget.style.display = "flex";
          chatToggle.style.display = "none";
        });
      
        closeBtn.addEventListener("click", () => {
          chatWidget.style.display = "none";
          chatToggle.style.display = "flex";
        });
      
        sendBtn.addEventListener("click", sendMessage);
        input.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });
      
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const period = hours < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
            const hour12 = hours % 12 === 0 ? 12 : hours % 12;
            return `ì˜¤ëŠ˜ ${period} ${hour12}:${minutes}`;
        }
          
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì±„íŒ… ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        document.getElementById("chat-time-initial").textContent = getCurrentTime();

        // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì‹œê°„ì„ ì¶”ì í•˜ëŠ” ë³€ìˆ˜
        let lastMessageTime = '';

        function sendMessage() {
          const text = input.value.trim();
          if (!text) return;
      
          console.log(`ì‚¬ìš©ì ë©”ì‹œì§€ ì „ì†¡: "${text}"`);
          
          const currentTime = getCurrentTime();
          
          // ì´ì „ ë©”ì‹œì§€ì™€ ì‹œê°„ì´ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
          if (currentTime !== lastMessageTime) {
            const timeStamp = document.createElement("div");
            timeStamp.className = "chat-time";
            timeStamp.textContent = currentTime;
            chatBody.appendChild(timeStamp);
            lastMessageTime = currentTime;
          }
          
          // ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸” ìƒì„± ë° ì¶”ê°€
          const userBubble = document.createElement("div");
          userBubble.className = "chat-bubble user";
          userBubble.textContent = text;
          chatBody.appendChild(userBubble);
          
          // ì…ë ¥ì°½ ë¹„ìš°ê¸°
          input.value = "";
          
          // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
          const loaderBubble = document.createElement("div");
          loaderBubble.className = "chat-bubble bot loading";
          loaderBubble.innerHTML = "<div class='loading-dots'><span></span><span></span><span></span></div>";
          chatBody.appendChild(loaderBubble);
          
          // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
          chatBody.scrollTop = chatBody.scrollHeight;
          
          // Rasa ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
          sendToRasaAndGetResponse(text, loaderBubble);
        }

        // ë´‡ ë©”ì‹œì§€ ë²„ë¸” ìƒì„± í•¨ìˆ˜
        function createBotMessageBubble(text) {
          const currentTime = getCurrentTime();
          
          // ì»¨í…Œì´ë„ˆ ìƒì„±
          const container = document.createDocumentFragment();
          
          // ì´ì „ ë©”ì‹œì§€ì™€ ì‹œê°„ì´ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
          if (currentTime !== lastMessageTime) {
            const timeStamp = document.createElement("div");
            timeStamp.className = "chat-time";
            timeStamp.textContent = currentTime;
            container.appendChild(timeStamp);
            lastMessageTime = currentTime;
          }
          
          // ë´‡ ë©”ì‹œì§€ ë²„ë¸” ìƒì„±
          const botBubble = document.createElement("div");
          botBubble.className = "chat-bubble bot";
          botBubble.textContent = text;
          container.appendChild(botBubble);
          
          return container;
        }

        // ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸” ìƒì„± í•¨ìˆ˜ (ëˆ„ë½ë¨)
        function createUserMessageBubble(text) {
          const currentTime = getCurrentTime();
          
          // ì»¨í…Œì´ë„ˆ ìƒì„±
          const container = document.createDocumentFragment();
          
          // ì´ì „ ë©”ì‹œì§€ì™€ ì‹œê°„ì´ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
          if (currentTime !== lastMessageTime) {
            const timeStamp = document.createElement("div");
            timeStamp.className = "chat-time";
            timeStamp.textContent = currentTime;
            container.appendChild(timeStamp);
            lastMessageTime = currentTime;
          }
          
          // ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸” ìƒì„±
          const userBubble = document.createElement("div");
          userBubble.className = "chat-bubble user";
          userBubble.textContent = text;
          container.appendChild(userBubble);
          
          return container;
        }

        // ë¡œë”© ë²„ë¸” ìƒì„± í•¨ìˆ˜ (ëˆ„ë½ë¨)
        function createLoaderBubble() {
          const loaderBubble = document.createElement("div");
          loaderBubble.className = "chat-bubble bot loading";
          loaderBubble.innerHTML = "<div class='loading-dots'><span></span><span></span><span></span></div>";
          return loaderBubble;
        }

        // ì‚¬ìš©ì ì„¸ì…˜ ID ìƒì„± (ê³ ìœ í•œ ëŒ€í™” ì‹ë³„ì)
        function generateSessionId() {
          return 'user_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
        const sessionId = generateSessionId();

        // Rasa ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡ ë° ì‘ë‹µ ì²˜ë¦¬
        async function sendToRasaAndGetResponse(text, loaderBubble) {
          try {
            console.log(`Rasaì— ë©”ì‹œì§€ ì „ì†¡: "${text}", ì„¸ì…˜ ID: ${sessionId}`);
            
            // Django ë°±ì—”ë“œ ê²½ë¡œë¥¼ í†µí•´ Rasaì— ìš”ì²­
            const response = await fetch("/parse_constraints/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
              },
              body: JSON.stringify({
                text: text,
                session_id: sessionId
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
            }

            const data = await response.json();
            
            // ë¡œë”© ë²„ë¸” ì œê±°
            if (loaderBubble && loaderBubble.parentNode) {
              loaderBubble.parentNode.removeChild(loaderBubble);
            }
            
            console.log('Rasa ì‘ë‹µ:', data);

            // ì‘ë‹µì´ ë¹„ì–´ìˆëŠ” ê²½ìš°
            if (data.length === 0) {
              const botBubble = createBotMessageBubble("ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ ì§ˆë¬¸ì„ í•´ë³´ì‹œê² ì–´ìš”?");
              chatBody.appendChild(botBubble);
              chatBody.scrollTop = chatBody.scrollHeight;
              return;
            }

            // ì‘ë‹µ ì²˜ë¦¬
            handleRasaResponse(data);
          } catch (error) {
            console.error("Rasa í†µì‹  ì˜¤ë¥˜:", error);
            
            // ë¡œë”© ë²„ë¸” ì œê±°
            if (loaderBubble && loaderBubble.parentNode) {
              loaderBubble.parentNode.removeChild(loaderBubble);
            }

            // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            const botBubble = createBotMessageBubble("ì—°ê²° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            chatBody.appendChild(botBubble);
            chatBody.scrollTop = chatBody.scrollHeight;
          }
        }

        // CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

        // Rasa ì‘ë‹µ ì²˜ë¦¬
        function handleRasaResponse(data) {
          // ê° ì‘ë‹µ ë©”ì‹œì§€ ì²˜ë¦¬
          data.forEach(message => {
            if (message.text) {
              const botBubble = createBotMessageBubble(message.text);
              chatBody.appendChild(botBubble);
            }
            
            // ì‹œê°„í‘œ ìƒì„± ì´ë²¤íŠ¸ ì²˜ë¦¬
            if (message.custom && message.custom.event_type === "initiate_timetable_generation_sse") {
              // ê¸°ì¡´ ì‹œê°„í‘œ ìƒì„± ë¡œì§ í˜¸ì¶œ
              handleTimetableGenerationEvent(message.custom);
            } else if (message.custom && message.custom.payload && message.custom.payload.event_type === "initiate_timetable_generation_sse") {
              // í˜ì´ë¡œë“œ í˜•ì‹ ì²˜ë¦¬
              handleTimetableGenerationEvent(message.custom.payload);
            }
            
            // ì‹œê°„í‘œ ì €ì¥ ì´ë²¤íŠ¸ ì²˜ë¦¬
            if (message.custom && message.custom.event_type === "save_timetable") {
              console.log("ì‹œê°„í‘œ ì €ì¥ ì´ë²¤íŠ¸ ìˆ˜ì‹ ë¨");
              console.log("í˜„ì¬ window.lastGeneratedTimetable:", window.lastGeneratedTimetable);
              
              // ì§ì ‘ ì‹œê°„í‘œ ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
              saveTimetableDirectly();
            }
            
            // ê³¼ëª© ì œì™¸ ë° ì¬ìƒì„± ì´ë²¤íŠ¸ ì²˜ë¦¬
            if (message.custom && message.custom.event_type === "exclude_and_regenerate_timetable") {
              handleExcludeAndRegenerateEvent(message.custom);
            }
            
            // ë²„íŠ¼ í‘œì‹œ (ì‹œê°„í‘œ ìƒì„± í›„ ì €ì¥ ë²„íŠ¼ í‘œì‹œ)
            if (message.buttons) {
              const buttonContainer = document.createElement("div");
              buttonContainer.className = "chat-buttons";
              buttonContainer.style.marginTop = "10px";
              
              message.buttons.forEach(button => {
                const btn = document.createElement("button");
                btn.className = "chat-button";
                btn.textContent = button.title;
                btn.style.marginRight = "5px";
                btn.style.padding = "5px 10px";
                btn.style.borderRadius = "5px";
                btn.style.border = "1px solid #ddd";
                btn.style.backgroundColor = "#f0f0f0";
                btn.style.cursor = "pointer";
                
                btn.onclick = () => {
                  // ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê²ƒì²˜ëŸ¼ ì²˜ë¦¬
                  input.value = button.payload;
                  sendMessage();
                };
                
                buttonContainer.appendChild(btn);
              });
              
              chatBody.appendChild(buttonContainer);
            }
          });
          
          chatBody.scrollTop = chatBody.scrollHeight;
        }

        // ê³¼ëª© ì œì™¸ ë° ì¬ìƒì„± ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleExcludeAndRegenerateEvent(data) {
          console.log("ê³¼ëª© ì œì™¸ ë° ì¬ìƒì„± ì´ë²¤íŠ¸ ìˆ˜ì‹ :", data);
          
          // í˜„ì¬ ì‹œê°„í‘œê°€ ìˆëŠ”ì§€ í™•ì¸
          if (!window.lastGeneratedTimetable || window.lastGeneratedTimetable.length === 0) {
            console.error("ìˆ˜ì •í•  ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.");
            const botBubble = createBotMessageBubble("ìˆ˜ì •í•  ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì‹œê°„í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.");
            chatBody.appendChild(botBubble);
            chatBody.scrollTop = chatBody.scrollHeight;
            return;
          }
          
          // ì œì•½ì¡°ê±´ ê°ì²´ë¥¼ ì™„ì „íˆ ìƒˆë¡œ ì´ˆê¸°í™” (ê¸°ì¡´ ì˜ëª»ëœ êµ¬ì¡° ì œê±°)
          window.constraints = {
            major_credits: data.major_credits || window.constraints?.major_credits || 0,
            elective_credits: data.elective_credits || window.constraints?.elective_credits || 0,
            required_courses: data.required_courses || window.constraints?.required_courses || [],
            free_days: data.free_days || window.constraints?.free_days || [],
            avoid_times: data.avoid_times || window.constraints?.avoid_times || [],
            avoid_time_ranges: data.avoid_time_ranges || window.constraints?.avoid_time_ranges || [],
            only_time_ranges: data.only_time_ranges || window.constraints?.only_time_ranges || [],
            exclude_courses: data.exclude_courses || [],
            existing_courses: [],
            is_modification: true
          };
          
          console.log("ì œì•½ì¡°ê±´ ì´ˆê¸°í™” ì™„ë£Œ:", window.constraints);
          
          // ê¸°ì¡´ ì‹œê°„í‘œì—ì„œ ì œì™¸í•  ê³¼ëª©ë“¤ì„ í•„í„°ë§í•˜ì—¬ ê³ ì •í•  ê³¼ëª© ëª©ë¡ ìƒì„±
          const excludeCoursesLower = data.exclude_courses.map(name => name.toLowerCase().trim());
          
          // ì œì™¸í•  ê³¼ëª©ì˜ ID ì°¾ê¸° (ê³¼ëª©ëª… â†’ ê³¼ëª© ì½”ë“œ ë³€í™˜)
          const excludeCourseIds = [];
          const fixedCourses = window.lastGeneratedTimetable.filter(course => {
            const courseNameLower = course.course_name.toLowerCase().trim();
            // ì œì™¸í•  ê³¼ëª©ëª…ì´ í˜„ì¬ ê³¼ëª©ëª…ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ë” ì •í™•í•œ ë§¤ì¹­)
            const shouldExclude = excludeCoursesLower.some(excludeName => {
              // ì •í™•í•œ ë§¤ì¹­ ìš°ì„ , ê·¸ ë‹¤ìŒ ë¶€ë¶„ ë§¤ì¹­
              return courseNameLower === excludeName || 
                     courseNameLower.includes(excludeName) ||
                     excludeName.includes(courseNameLower);
            });
            
            if (shouldExclude) {
              excludeCourseIds.push(String(course.course_id));
              console.log(`ì œì™¸í•  ê³¼ëª© ë°œê²¬: ${course.course_name} (ID: ${course.course_id})`);
            }
            
            return !shouldExclude;
          });
          
          console.log("í˜„ì¬ ì‹œê°„í‘œ:", window.lastGeneratedTimetable.map(c => c.course_name));
          console.log("ì œì™¸í•  ê³¼ëª©ë“¤ (ì´ë¦„):", data.exclude_courses);
          console.log("ì œì™¸í•  ê³¼ëª©ë“¤ (ID):", excludeCourseIds);
          console.log("ê³ ì •í•  ê³¼ëª©ë“¤:", fixedCourses.map(c => c.course_name));
          
          // ê³ ì •í•  ê³¼ëª©ë“¤ì˜ IDë¥¼ existing_coursesë¡œ ì„¤ì •
          window.constraints.existing_courses = fixedCourses.map(course => String(course.course_id));
          
          // ì œì™¸í•  ê³¼ëª©ì„ ê³¼ëª© ì½”ë“œë¡œ ì„¤ì • (ê³¼ëª©ëª… ëŒ€ì‹ )
          window.constraints.exclude_courses = excludeCourseIds;
          
          console.log("ì„¤ì •ëœ existing_courses:", window.constraints.existing_courses);
          console.log("ì„¤ì •ëœ exclude_courses (ID):", window.constraints.exclude_courses);
          console.log("ìˆ˜ì • ëª¨ë“œ í™œì„±í™”:", window.constraints.is_modification);
          console.log("ìµœì¢… ì œì•½ì¡°ê±´ í™•ì¸:", window.constraints);

          
          // ì‹œê°„í‘œ ì¬ìƒì„± (ìˆ˜ì • ëª¨ë“œ) - ì œì•½ì¡°ê±´ì´ ì„¤ì •ëœ í›„ í˜¸ì¶œ
          // generateTimetableFromNL("ì‹œê°„í‘œ ìˆ˜ì • ìš”ì²­") ëŒ€ì‹  ì§ì ‘ API í˜¸ì¶œ
          generateTimetableDirectly().then(() => {
            // ìˆ˜ì • ì™„ë£Œ í›„ ë©”ì‹œì§€
            setTimeout(() => {
              const completeBubble = createBotMessageBubble("ì‹œê°„í‘œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ë§ˆìŒì— ë“œì‹œë‚˜ìš”?");
              chatBody.appendChild(completeBubble);
              
              // ì €ì¥ ë²„íŠ¼ ì¶”ê°€
              const buttonContainer = document.createElement("div");
              buttonContainer.className = "chat-buttons";
              buttonContainer.style.marginTop = "10px";
              
              const saveButton = document.createElement("button");
              saveButton.className = "bookmarkBtn";
              saveButton.innerHTML = `
                <span class="IconContainer">
                  <svg viewBox="0 0 384 512" height="0.9em" class="icon">
                    <path d="M0 48V487.7C0 501.1 10.9 512 24.3 512c5 0 9.9-1.5 14-4.4L192 400 345.7 507.6c4.1 2.9 9 4.4 14 4.4c13.4 0 24.3-10.9 24.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5 0 0 21.5 0 48z"></path>
                  </svg>
                </span>
                <p class="text">ì €ì¥í•˜ê¸°</p>
              `;
              
              saveButton.onclick = () => {
                saveTimetableDirectly();
              };
              
              buttonContainer.appendChild(saveButton);
              chatBody.appendChild(buttonContainer);
              chatBody.scrollTop = chatBody.scrollHeight;
            }, 1000);
          }).catch(error => {
            console.error("ì‹œê°„í‘œ ì¬ìƒì„± ì˜¤ë¥˜:", error);
            const errorBubble = createBotMessageBubble("ì‹œê°„í‘œ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            chatBody.appendChild(errorBubble);
            chatBody.scrollTop = chatBody.scrollHeight;
          });
        }

        // ì§ì ‘ ì‹œê°„í‘œ ìƒì„± í•¨ìˆ˜ (Rasa íŒŒì‹± ì—†ì´)
        async function generateTimetableDirectly() {
          return new Promise((resolve, reject) => {
            console.log("ì§ì ‘ ì‹œê°„í‘œ ìƒì„± ì‹œì‘");
            console.log("í˜„ì¬ ì œì•½ì¡°ê±´:", window.constraints);
            console.log("ì œì™¸í•  ê³¼ëª© í™•ì¸:", window.constraints.exclude_courses);
            console.log("window.constraints íƒ€ì…:", typeof window.constraints);
            console.log("window.constraints í‚¤ë“¤:", Object.keys(window.constraints));
            
            // window.constraintsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
            if (Array.isArray(window.constraints)) {
              console.log("âš ï¸ window.constraintsê°€ ë°°ì—´ì…ë‹ˆë‹¤! ê°ì²´ë¡œ ë³€í™˜ í•„ìš”");
              // ë°°ì—´ì—ì„œ ì‹¤ì œ ì œì•½ì¡°ê±´ ê°ì²´ ì°¾ê¸°
              const constraintObj = window.constraints.find(item => 
                item && typeof item === 'object' && 
                (item.major_credits || item.exclude_courses || item.free_days)
              );
              if (constraintObj) {
                console.log("ë°°ì—´ì—ì„œ ì œì•½ì¡°ê±´ ê°ì²´ ë°œê²¬:", constraintObj);
                window.constraints = constraintObj;
              }
            }
            
            console.log("ìµœì¢… ì œì•½ì¡°ê±´ ê°ì²´:", window.constraints);
            console.log("ìµœì¢… ì œì™¸í•  ê³¼ëª©:", window.constraints.exclude_courses);
            
            // íŒŒë¼ë¯¸í„°ë¥¼ ì§ì ‘ êµ¬ì„± (buildParamsFromConstraints ëŒ€ì‹ )
            const idsToUse = window.constraints.existing_courses || [];
            console.log("ì§ì ‘ íŒŒë¼ë¯¸í„° êµ¬ì„± - idsToUse:", idsToUse);
            console.log("ì§ì ‘ íŒŒë¼ë¯¸í„° êµ¬ì„± - exclude_courses:", window.constraints.exclude_courses);
            
            // URLSearchParams ì§ì ‘ ìƒì„±
            const paramsObject = new URLSearchParams();
            
            // í•™ì  ì •ë³´ ì¶”ê°€
            const totalCredits = (window.constraints.major_credits || 0) + (window.constraints.elective_credits || 0);
            paramsObject.append("total_credits", totalCredits);
            paramsObject.append("major_credits", window.constraints.major_credits || 0);
            paramsObject.append("elective_credits", window.constraints.elective_credits || 0);
            
            // ê¸°ì¡´ ê³¼ëª© ì¶”ê°€
            idsToUse.forEach(id => {
              paramsObject.append("existing_courses[]", id);
            });
            
            // ê³µê°• ìš”ì¼ ì¶”ê°€
            if (window.constraints.free_days && window.constraints.free_days.length > 0) {
              window.constraints.free_days.forEach(day => {
                paramsObject.append("free_days[]", day);
              });
            }
            
            // ì œì™¸í•  ê³¼ëª© ì¶”ê°€ (í•µì‹¬!)
            if (window.constraints.exclude_courses && window.constraints.exclude_courses.length > 0) {
              console.log("ì œì™¸í•  ê³¼ëª© ì§ì ‘ ì¶”ê°€ ì‹œì‘:", window.constraints.exclude_courses);
              window.constraints.exclude_courses.forEach(course => {
                paramsObject.append("exclude_courses[]", course);
                console.log("ì œì™¸í•  ê³¼ëª© ì§ì ‘ ì¶”ê°€ë¨:", course);
              });
              console.log("ì œì™¸í•  ê³¼ëª© ì§ì ‘ ì¶”ê°€ ì™„ë£Œ");
            }
            
            const paramsString = paramsObject.toString();
            
            console.log("ì§ì ‘ ìƒì„± - ì‚¬ìš©í•  IDë“¤:", idsToUse);
            console.log("ì§ì ‘ ìƒì„± - URL íŒŒë¼ë¯¸í„°:", paramsString);
            
            // exclude_coursesê°€ URLì— í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (window.constraints.exclude_courses && window.constraints.exclude_courses.length > 0) {
              console.log("ì œì™¸í•  ê³¼ëª©ì´ URLì— í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸:", paramsString.includes('exclude_courses'));
              console.log("URL íŒŒë¼ë¯¸í„° ì „ì²´:", paramsString);
              console.log("exclude_courses ê²€ìƒ‰ ê²°ê³¼:", paramsString.indexOf('exclude_courses'));
            }
            
            // SSEë¡œ ì‹œê°„í‘œ ìƒì„± ìŠ¤íŠ¸ë¦¼ ìš”ì²­
            const eventSourceUrl = "/generate_timetable_stream/?" + decodeURIComponent(paramsString);
            console.log("ì§ì ‘ ìƒì„± - EventSource URL:", eventSourceUrl);
            
            const evtSource = new EventSource(eventSourceUrl);
            const progressOverlay = document.getElementById("progress-overlay");
            const progressText = document.getElementById("progress-text");

            progressOverlay.style.display = "block";
            progressText.textContent = "ì‹œê°„í‘œ ìˆ˜ì • ì¤‘â€¦";

            evtSource.onmessage = e => {
              const data = JSON.parse(e.data);
              if (data.progress === "ì™„ë£Œ") {
                window.timetables = data.timetables;
                window.currentIndex = 0;
                
                // ìˆ˜ì • ëª¨ë“œ ì™„ë£Œ í›„ í”Œë˜ê·¸ ì´ˆê¸°í™”
                if (window.constraints.is_modification) {
                  console.log("ìˆ˜ì • ëª¨ë“œ ì™„ë£Œ, ì œì•½ì¡°ê±´ ìœ ì§€");
                  window.constraints.is_modification = false;
                }
                
                setTimeout(() => progressOverlay.style.display = "none", 800);
                applyTimetableToMiddlePanel();
                evtSource.close();
                resolve();
              } else {
                let progressMsg = "ì‹œê°„í‘œ ìˆ˜ì • ì¤‘...";
                if (data.processed !== undefined && data.found !== undefined) {
                  progressMsg = `ì²˜ë¦¬ëœ ì¡°í•©: ${data.processed}, í›„ë³´: ${data.found}`;
                }
                progressText.textContent = progressMsg;
              }
            };

            evtSource.onerror = () => {
              progressText.textContent = "ì‹œê°„í‘œ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
              evtSource.close();
              setTimeout(() => progressOverlay.style.display = "none", 1200);
              reject(new Error("ì‹œê°„í‘œ ìˆ˜ì • ì˜¤ë¥˜"));
            };
          });
        }

        const progressOverlay = document.getElementById("progress-overlay");
        const progressText    = document.getElementById("progress-text");
        const progressFill    = document.getElementById("progress-fill");
        const progressCount   = document.getElementById("progress-count");
        
        // ì‹œê°„í‘œ ì €ì¥ì„ ì§ì ‘ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
        async function saveTimetableDirectly() {
          console.log("ì‹œê°„í‘œ ì €ì¥ í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œë¨");
          console.log("window.lastGeneratedTimetable:", window.lastGeneratedTimetable);
          
          // í˜„ì¬ í‘œì‹œëœ ì‹œê°„í‘œê°€ ìˆëŠ”ì§€ í™•ì¸
          if (!window.lastGeneratedTimetable || window.lastGeneratedTimetable.length === 0) {
            console.error("ì €ì¥í•  ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.");
            const botBubble = createBotMessageBubble("ì €ì¥í•  ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì‹œê°„í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.");
            chatBody.appendChild(botBubble);
            chatBody.scrollTop = chatBody.scrollHeight;
            return;
          }
          
          console.log("ì‹œê°„í‘œ ë°ì´í„° ê²€ì¦ í†µê³¼");
          
          // ì €ì¥í•  ì‹œê°„í‘œ ë°ì´í„° ì¤€ë¹„
          const timetableData = {
            courses: window.lastGeneratedTimetable.map(course => ({
              course_id: course.course_id,
              course_name: course.course_name,
              credit: course.credit,
              category: course.category,
              schedules: course.schedules,
              location: course.location || '',
              note: '',
              color: ''
            })),
            title: '' // ì„œë²„ì—ì„œ ìë™ ìƒì„±
          };
          
          console.log("ì €ì¥í•  ì‹œê°„í‘œ ë°ì´í„°:", timetableData);
          console.log("ì²« ë²ˆì§¸ ê³¼ëª© ìƒì„¸:", timetableData.courses[0]);
          if (timetableData.courses[0] && timetableData.courses[0].schedules) {
            console.log("ì²« ë²ˆì§¸ ê³¼ëª© ìŠ¤ì¼€ì¤„:", timetableData.courses[0].schedules);
          }
          
          console.log("ì„œë²„ë¡œ ìš”ì²­ ì „ì†¡ ì‹œì‘...");
          
          try {
            // ì„œë²„ì— ì‹œê°„í‘œ ì €ì¥ ìš”ì²­
            const response = await fetch('/save_timetable/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
              },
              body: JSON.stringify(timetableData)
            });
            
            console.log("ì„œë²„ ì‘ë‹µ ìƒíƒœ:", response.status);
            const result = await response.json();
            console.log("ì €ì¥ ì‘ë‹µ:", result);
            
            if (response.ok && result.success) {
              const botBubble = createBotMessageBubble("ì‹œê°„í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! 'ë‚´ ì‹œê°„í‘œ ê´€ë¦¬' í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
              chatBody.appendChild(botBubble);
            } else {
              const botBubble = createBotMessageBubble("ì‹œê°„í‘œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + (result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
              chatBody.appendChild(botBubble);
            }
            chatBody.scrollTop = chatBody.scrollHeight;
          } catch (error) {
            console.error("ì‹œê°„í‘œ ì €ì¥ ì˜¤ë¥˜:", error);
            console.error("ì˜¤ë¥˜ ìƒì„¸:", error.stack);
            const botBubble = createBotMessageBubble("ì‹œê°„í‘œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            chatBody.appendChild(botBubble);
            chatBody.scrollTop = chatBody.scrollHeight;
          }
        }

        // ì‹œê°„í‘œ ìƒì„± ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì´ˆê¸° ìƒì„±ìš©)
        function handleTimetableGenerationEvent(data) {
          console.log("ì‹œê°„í‘œ ìƒì„± ì´ë²¤íŠ¸ ìˆ˜ì‹ :", data);
          
          // ìƒì„±ëœ ë°ì´í„°ë¥¼ window.constraintsì— ë¨¼ì € ì €ì¥
          if (data.major_credits) window.constraints.major_credits = data.major_credits;
          if (data.elective_credits) window.constraints.elective_credits = data.elective_credits;
          if (data.required_courses) window.constraints.required_courses = data.required_courses;
          if (data.free_days) window.constraints.free_days = data.free_days;
          if (data.avoid_times) window.constraints.avoid_times = data.avoid_times;
          if (data.avoid_time_ranges) window.constraints.avoid_time_ranges = data.avoid_time_ranges;
          if (data.only_time_ranges) window.constraints.only_time_ranges = data.only_time_ranges;
          
          // íŠ¹ì • ì‹œê°„ëŒ€ ê³µê°• ì •ë³´ ì €ì¥ (ì¶”ê°€)
          if (data.specific_avoid_times) window.constraints.specific_avoid_times = data.specific_avoid_times;
          if (data.specific_avoid_time_ranges) window.constraints.specific_avoid_time_ranges = data.specific_avoid_time_ranges;
          
          console.log("window.constraints ì—…ë°ì´íŠ¸ ì™„ë£Œ:", window.constraints);
          
          // ì‹œê°„í‘œ ìƒì„± í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ NL ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •
          generateTimetableFromNL("ì‹œê°„í‘œ ìƒì„±í•´ì¤˜").then(() => {
            // ì‹œê°„í‘œ ìƒì„± ì™„ë£Œ í›„ ì €ì¥ ë²„íŠ¼ í‘œì‹œ
            setTimeout(() => {
              // ê¸°ì¡´ ì™„ë£Œ ë©”ì‹œì§€ì™€ ë²„íŠ¼ë“¤ì„ ëª¨ë‘ ì œê±°
              const existingMessages = chatBody.querySelectorAll('.chat-bubble.bot');
              existingMessages.forEach(bubble => {
                if (bubble.textContent.includes('ì‹œê°„í‘œê°€ ë§ˆìŒì— ë“œì‹œë‚˜ìš”')) {
                  bubble.remove();
                }
              });
              
              // ê¸°ì¡´ ì‹œê°„í‘œ ì €ì¥ ë²„íŠ¼ë“¤ì„ ëª¨ë‘ ì œê±°
              const existingButtons = chatBody.querySelectorAll('.chat-buttons');
              existingButtons.forEach(container => {
                // ì‹œê°„í‘œ ì €ì¥ í…ìŠ¤íŠ¸ê°€ í¬í•¨ëœ ë²„íŠ¼ì´ ìˆëŠ” ì»¨í…Œì´ë„ˆ ì œê±°
                const buttons = container.querySelectorAll('button');
                let hasSaveButton = false;
                buttons.forEach(btn => {
                  if (btn.textContent.includes('ì‹œê°„í‘œ ì €ì¥')) {
                    hasSaveButton = true;
                  }
                });
                if (hasSaveButton) {
                  container.remove();
                }
              });
              
              const completeBubble = createBotMessageBubble("ì‹œê°„í‘œê°€ ë§ˆìŒì— ë“œì‹œë‚˜ìš”? ì €ì¥í•˜ì‹œê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”!");
              chatBody.appendChild(completeBubble);
              
              // ì €ì¥ ë²„íŠ¼ ì¶”ê°€
              const buttonContainer = document.createElement("div");
              buttonContainer.className = "chat-buttons";
              buttonContainer.style.marginTop = "10px";
              
              const saveButton = document.createElement("button");
              saveButton.className = "bookmarkBtn"; // ìƒˆë¡œìš´ ë””ìì¸ í´ë˜ìŠ¤
              saveButton.innerHTML = `
                <span class="IconContainer">
                  <svg viewBox="0 0 384 512" height="0.9em" class="icon">
                    <path d="M0 48V487.7C0 501.1 10.9 512 24.3 512c5 0 9.9-1.5 14-4.4L192 400 345.7 507.6c4.1 2.9 9 4.4 14 4.4c13.4 0 24.3-10.9 24.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5 0 0 21.5 0 48z"></path>
                  </svg>
                </span>
                <p class="text">ì €ì¥í•˜ê¸°</p>
              `;
              
              saveButton.onclick = () => {
                saveTimetableDirectly();
              };
              
              buttonContainer.appendChild(saveButton);
              chatBody.appendChild(buttonContainer);
              chatBody.scrollTop = chatBody.scrollHeight;
            }, 1000);
          });
        }
    </script>
      



    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© JS ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ì—…ë°ì´íŠ¸ëœ timetable_script.js íŒŒì¼ ì—°ê²° -->
</body>
</html>